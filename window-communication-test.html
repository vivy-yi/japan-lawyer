<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çª—å£é€šä¿¡æµ‹è¯• - Window Communication Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .test-section {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .test-section h2 {
            margin-top: 0;
            color: #ffd700;
            font-size: 1.5em;
        }

        .language-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .lang-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 25px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            min-width: 120px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .lang-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .lang-btn:active {
            transform: translateY(0);
        }

        .status-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-left: 4px solid #00ff00;
        }

        .status-panel.error {
            border-left-color: #ff4444;
        }

        .status-panel.warning {
            border-left-color: #ffaa00;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #ffd700;
        }

        .instructions h3 {
            margin-top: 0;
            color: #ffd700;
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin: 10px 0;
            line-height: 1.6;
        }

        .window-info {
            background: rgba(100, 200, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(100, 200, 255, 0.3);
        }

        .highlight {
            background: rgba(255, 215, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        .log-area {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-entry.info {
            color: #00ff00;
        }

        .log-entry.warning {
            color: #ffaa00;
        }

        .log-entry.error {
            color: #ff4444;
        }

        .test-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .test-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .current-language {
            text-align: center;
            font-size: 2em;
            font-weight: bold;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .window-id {
            font-size: 0.8em;
            opacity: 0.7;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ çª—å£é—´è¯­è¨€åˆ‡æ¢é€šä¿¡æµ‹è¯•</h1>

        <div class="current-language" id="currentLanguageDisplay">
            å½“å‰è¯­è¨€: ä¸­æ–‡ (zh)
        </div>

        <div class="window-id" id="windowIdDisplay">
            çª—å£ID: åŠ è½½ä¸­...
        </div>

        <div class="test-section">
            <h2>ğŸ›ï¸ è¯­è¨€åˆ‡æ¢æ§åˆ¶</h2>
            <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®åˆ‡æ¢è¯­è¨€ï¼Œå…¶ä»–æ‰“å¼€çš„æµ‹è¯•çª—å£ä¼šè‡ªåŠ¨åŒæ­¥ï¼š</p>

            <div class="language-buttons">
                <button class="lang-btn" onclick="switchLanguageInAllWindows('zh')">
                    ğŸ‡¨ğŸ‡³ ä¸­æ–‡
                </button>
                <button class="lang-btn" onclick="switchLanguageInAllWindows('ja')">
                    ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª
                </button>
                <button class="lang-btn" onclick="switchLanguageInAllWindows('en')">
                    ğŸ‡ºğŸ‡¸ English
                </button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š é€šä¿¡çŠ¶æ€</h2>
            <div class="status-panel" id="statusPanel">
                åˆå§‹åŒ–ä¸­...
            </div>

            <div class="window-info" id="windowInfo">
                <strong>çª—å£ä¿¡æ¯:</strong><br>
                çª—å£æ•°é‡: <span id="windowCount">æ£€æµ‹ä¸­...</span><br>
                æœ€åå¿ƒè·³: <span id="lastHeartbeat">ç­‰å¾…ä¸­...</span><br>
                å¹¿æ’­é¢‘é“: <span id="broadcastStatus">æ£€æµ‹ä¸­...</span>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª æµ‹è¯•åŠŸèƒ½</h2>
            <div class="test-controls">
                <button class="test-btn" onclick="openNewTestWindow()">ğŸªŸ æ‰“å¼€æ–°æµ‹è¯•çª—å£</button>
                <button class="test-btn" onclick="testCommunication()">ğŸ“¡ æµ‹è¯•é€šä¿¡</button>
                <button class="test-btn" onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
                <button class="test-btn" onclick="toggleWindowComm()">ğŸ”§ åˆ‡æ¢é€šä¿¡</button>
            </div>
        </div>

        <div class="instructions">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <ol>
                <li>åœ¨å½“å‰é¡µé¢ç‚¹å‡»<span class="highlight">æ‰“å¼€æ–°æµ‹è¯•çª—å£</span>æŒ‰é’®åˆ›å»ºå¤šä¸ªçª—å£</li>
                <li>åœ¨<span class="highlight">ä»»æ„ä¸€ä¸ªçª—å£</span>ä¸­ç‚¹å‡»è¯­è¨€åˆ‡æ¢æŒ‰é’®</li>
                <li>è§‚å¯Ÿ<span class="highlight">æ‰€æœ‰çª—å£</span>çš„è¯­è¨€æ˜¯å¦åŒæ­¥åˆ‡æ¢</li>
                <li>æŸ¥çœ‹æ—¥å¿—åŒºåŸŸäº†è§£é€šä¿¡è¿‡ç¨‹çš„è¯¦ç»†ä¿¡æ¯</li>
                <li>å¯ä»¥å°è¯•åœ¨ä¸åŒæµè§ˆå™¨æ ‡ç­¾é¡µæˆ–çª—å£ä¸­æ‰“å¼€æµ‹è¯•é¡µé¢</li>
            </ol>

            <p><strong>æ”¯æŒçš„é€šä¿¡æ–¹å¼:</strong></p>
            <ul>
                <li>âœ… BroadcastChannel (ç°ä»£æµè§ˆå™¨)</li>
                <li>âœ… postMessage (è·¨çª—å£é€šä¿¡)</li>
                <li>âœ… localStorage (é™çº§æ–¹æ¡ˆ)</li>
                <li>âœ… CustomEvent (å†…éƒ¨äº‹ä»¶ç³»ç»Ÿ)</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>ğŸ“ é€šä¿¡æ—¥å¿—</h2>
            <div class="log-area" id="logArea"></div>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="js/core/window-communication.js"></script>

    <script>
        // æ—¥å¿—ç³»ç»Ÿ
        let logContainer;
        let logEntries = [];
        const MAX_LOG_ENTRIES = 100;

        function initLogger() {
            logContainer = document.getElementById('logArea');
            addLog('æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ', 'info');
            addLog('å¼€å§‹åŠ è½½çª—å£é€šä¿¡ç®¡ç†å™¨...', 'info');
        }

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                type
            };

            logEntries.push(logEntry);
            if (logEntries.length > MAX_LOG_ENTRIES) {
                logEntries.shift();
            }

            updateLogDisplay();
        }

        function updateLogDisplay() {
            if (!logContainer) return;

            // æ¸…ç©ºç°æœ‰å†…å®¹
            while (logContainer.firstChild) {
                logContainer.removeChild(logContainer.firstChild);
            }

            // å®‰å…¨åœ°æ·»åŠ æ—¥å¿—æ¡ç›®
            logEntries.forEach(entry => {
                const logDiv = document.createElement('div');
                logDiv.className = `log-entry ${entry.type}`;

                const timestamp = document.createTextNode(`[${entry.timestamp}] `);
                const message = document.createTextNode(String(entry.message));

                logDiv.appendChild(timestamp);
                logDiv.appendChild(message);
                logContainer.appendChild(logDiv);
            });

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // çŠ¶æ€æ›´æ–°
        function updateStatus() {
            if (window.windowCommManager) {
                const status = window.windowCommManager.getStatus();
                const statusPanel = document.getElementById('statusPanel');
                const windowInfo = document.getElementById('windowInfo');

                if (status.isInitialized) {
                    statusPanel.className = 'status-panel';
                    statusPanel.textContent = `âœ… çª—å£é€šä¿¡ç®¡ç†å™¨å·²åˆå§‹åŒ–
å¯ç”¨çŠ¶æ€: ${status.isEnabled ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}
å½“å‰è¯­è¨€: ${status.currentLanguage}
è¿æ¥çª—å£: ${status.connectedWindows.length}
å¹¿æ’­é¢‘é“: ${status.hasBroadcastChannel ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}`;

                    if (windowInfo) {
                        windowInfo.innerHTML = `<strong>çª—å£ä¿¡æ¯:</strong><br>
çª—å£æ•°é‡: <span>${status.connectedWindows.length}</span><br>
å½“å‰è¯­è¨€: ${status.currentLanguage}<br>
å¹¿æ’­é¢‘é“: ${status.hasBroadcastChannel ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}<br>
æœ€åå¿ƒè·³: ${new Date(status.lastHeartbeat).toLocaleTimeString()}`;
                    }

                    // å®‰å…¨åœ°æ›´æ–°å…¶ä»–å…ƒç´ 
                    const windowCountEl = document.getElementById('windowCount');
                    if (windowCountEl) windowCountEl.textContent = status.connectedWindows.length;

                    const lastHeartbeatEl = document.getElementById('lastHeartbeat');
                    if (lastHeartbeatEl) lastHeartbeatEl.textContent = new Date(status.lastHeartbeat).toLocaleTimeString();

                    const broadcastStatusEl = document.getElementById('broadcastStatus');
                    if (broadcastStatusEl) broadcastStatusEl.textContent = status.hasBroadcastChannel ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ';
                } else {
                    statusPanel.className = 'status-panel error';
                    statusPanel.textContent = 'âŒ çª—å£é€šä¿¡ç®¡ç†å™¨æœªåˆå§‹åŒ–';
                }
            } else {
                const statusPanel = document.getElementById('statusPanel');
                if (statusPanel) {
                    statusPanel.className = 'status-panel error';
                    statusPanel.textContent = 'âŒ çª—å£é€šä¿¡ç®¡ç†å™¨æœªåŠ è½½';
                }
            }
        }

        // æ›´æ–°è¯­è¨€æ˜¾ç¤º
        function updateLanguageDisplay(language) {
            const display = document.getElementById('currentLanguageDisplay');
            const langNames = {
                'zh': 'ä¸­æ–‡ (zh)',
                'ja': 'æ—¥æœ¬èª (ja)',
                'en': 'English (en)'
            };
            if (display) {
                display.textContent = `å½“å‰è¯­è¨€: ${langNames[language] || language}`;
            }
        }

        // æ›´æ–°çª—å£IDæ˜¾ç¤º
        function updateWindowId() {
            if (window.windowCommManager) {
                const windowId = window.windowCommManager.getWindowId();
                const windowIdDisplay = document.getElementById('windowIdDisplay');
                if (windowIdDisplay) {
                    windowIdDisplay.textContent = `çª—å£ID: ${windowId}`;
                }
                addLog(`çª—å£ID: ${windowId}`, 'info');
            }
        }

        // æµ‹è¯•åŠŸèƒ½
        function openNewTestWindow() {
            const url = window.location.href;
            const newWindow = window.open(url, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');

            if (newWindow) {
                addLog('æˆåŠŸæ‰“å¼€æ–°æµ‹è¯•çª—å£', 'info');
            } else {
                addLog('æ‰“å¼€æ–°çª—å£å¤±è´¥ï¼Œå¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢', 'error');
            }
        }

        function testCommunication() {
            if (window.windowCommManager) {
                addLog('å¼€å§‹é€šä¿¡æµ‹è¯•...', 'info');
                // å‘é€æµ‹è¯•æ¶ˆæ¯
                window.windowCommManager.switchLanguage('zh', 'communication-test');
                addLog('å‘é€æµ‹è¯•è¯­è¨€åˆ‡æ¢æ¶ˆæ¯', 'info');
            } else {
                addLog('çª—å£é€šä¿¡ç®¡ç†å™¨æœªå¯ç”¨', 'error');
            }
        }

        function clearLog() {
            logEntries = [];
            updateLogDisplay();
            addLog('æ—¥å¿—å·²æ¸…é™¤', 'info');
        }

        function toggleWindowComm() {
            if (window.windowCommManager) {
                const status = window.windowCommManager.getStatus();
                window.windowCommManager.setEnabled(!status.isEnabled);
                addLog(`çª—å£é€šä¿¡${!status.isEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'info');
                updateStatus();
            }
        }

        // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶
        window.addEventListener('languageChanged', (event) => {
            const { language, source } = event.detail || {};
            addLog(`è¯­è¨€åˆ‡æ¢äº‹ä»¶: ${language} (æ¥æº: ${source})`, 'info');
            updateLanguageDisplay(language);
        });

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initLogger();

            // ç­‰å¾…çª—å£é€šä¿¡ç®¡ç†å™¨åŠ è½½
            setTimeout(() => {
                if (window.windowCommManager) {
                    addLog('çª—å£é€šä¿¡ç®¡ç†å™¨åŠ è½½æˆåŠŸ', 'info');
                    updateWindowId();
                    updateStatus();

                    // å®‰å…¨åœ°è·å–å½“å‰è¯­è¨€
                    const currentLang = window.windowCommManager.state && window.windowCommManager.state.currentLanguage
                        ? window.windowCommManager.state.currentLanguage
                        : 'zh';
                    updateLanguageDisplay(currentLang);

                    // å®šæœŸæ›´æ–°çŠ¶æ€
                    setInterval(updateStatus, 5000);
                } else {
                    addLog('çª—å£é€šä¿¡ç®¡ç†å™¨åŠ è½½å¤±è´¥', 'error');
                    const statusPanel = document.getElementById('statusPanel');
                    if (statusPanel) {
                        statusPanel.className = 'status-panel error';
                        statusPanel.textContent = 'âŒ çª—å£é€šä¿¡ç®¡ç†å™¨åŠ è½½å¤±è´¥';
                    }
                }
            }, 1000);
        });

        // ç›‘å¬çª—å£ç„¦ç‚¹å˜åŒ–
        window.addEventListener('focus', () => {
            addLog('çª—å£è·å¾—ç„¦ç‚¹', 'info');
            updateStatus();
        });

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                addLog('é¡µé¢å˜ä¸ºå¯è§', 'info');
                updateStatus();
            }
        });

        // é¡µé¢å¸è½½å‰æ¸…ç†
        window.addEventListener('beforeunload', () => {
            addLog('é¡µé¢å³å°†å¸è½½', 'warning');
        });

        addLog('æµ‹è¯•è„šæœ¬åŠ è½½å®Œæˆ', 'info');
    </script>
</body>
</html>